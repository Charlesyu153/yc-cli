# YC-CLI RAG 系统设计

**日期**: 2026-01-22
**目标**: 通过向量检索实现 AI 跨会话记忆，减少"手动告诉 AI 读什么"的负担

---

## 一、核心决策

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 部署方式 | 本地 HTTP 服务 | AI 可自动调用，无需人工介入 |
| 数据存储 | 保留 md 文件为权威源 | 保持现有工作流，git 版本控制 |
| 索引范围 | 仅 `MANIFEST.md` + `insights/*.md` | 避免把整个代码库塞进向量库；代码通过指针按需读取 |
| 向量数据库 | ChromaDB | 本地文件，无额外依赖 |
| 嵌入模型 | sentence-transformers | 本地运行，无 API 成本 |
| 文档创建 | AI 自动生成 + 人工确认 | 任务完成时触发，减少遗忘 |
| 同步方式 | 文件变化自动检测 | 简单可靠，无感知 |
| 迁移方式 | 打包 .rag/ + ai-docs/ | 复制即用，跨平台 |

---

## 二、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                               │
│  ┌─────────────┐    ┌─────────────┐                        │
│  │  人类编辑   │    │  AI 查询    │                        │
│  │  .md 文件   │    │  HTTP API   │                        │
│  └──────┬──────┘    └──────┬──────┘                        │
└─────────┼──────────────────┼───────────────────────────────┘
          │                  │
          ▼                  ▼
┌─────────────────────────────────────────────────────────────┐
│                        文件层                               │
│  ai-docs/current/{task}/                                    │
│  ├── MANIFEST.md         # 当前状态                          │
│  └── insights/           # 洞察记录                          │
│      ├── insight_01.md                                       │
│      └── ...                                               │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼ inotify / 定期扫描
┌─────────────────────────────────────────────────────────────┐
│                       服务层 (localhost:8733)               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  POST /index           # 触发索引更新                 │   │
│  │  GET  /search?q=xxx    # 语义搜索                     │   │
│  │  GET  /status          # 索引状态                     │   │
│  │  POST /record          # 保存 AI 生成的记录           │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                   │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ChromaDB (本地) + 嵌入缓存                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、数据结构

### 3.1 向量数据库 Schema

```python
{
    "id": "unique_id",              # 稳定 ID（建议：sha1(file_path) 或直接用 file_path）
    "content": "完整内容",
    "metadata": {
        "title": "标题",
        "tags": ["tag1", "tag2"],
        "status": "done|draft|todo|deprecated",
        "priority": "high|medium|low",
        "created": "2025-01-22",
        "file_path": "ai-docs/...",
        "task": "任务名",
        "has_pointers": True,
        "related_paths": "repo/relative/path.ext,repo/relative/other.ext"
    }
}
```

### 3.2 API 响应格式

```json
// GET /search?q=数据库连接&top_k=5
{
    "query": "数据库连接",
    "results": [
        {
            "id": "insight_01",
            "score": 0.92,
            "title": "数据库连接超时问题",
            "summary": "连接池配置不当导致...",
            "file_path": "ai-docs/current/task/insights/insight_01.md",
            "has_pointers": true,
            "related_paths": ["pipelines/qc.nf"]
        }
    ]
}
```

---

## 四、技术栈

| 组件 | 选择 | 版本 |
|------|------|------|
| 语言 | Python | 3.10+ |
| Web 框架 | FastAPI | latest |
| 向量数据库 | ChromaDB | latest |
| 嵌入模型 | sentence-transformers | all-MiniLM-L6-v2 |
| 文件监听 | watchdog | latest |

---

## 五、项目结构

```
yc-cli/
├── rag/                          # RAG 服务核心
│   ├── server.py                 # FastAPI 服务
│   ├── vector_store.py           # ChromaDB 封装
│   ├── embeddings.py             # 嵌入生成
│   ├── indexer.py                # 文件索引构建
│   ├── recorder.py               # 自动记录生成器
│   ├── file_watcher.py           # 文件监听
│   └── config.py                 # 配置
├── ai-docs/                      # 现有文档
│   └── current/{task}/
│       ├── MANIFEST.md
│       └── insights/
├── .rag/                         # RAG 数据目录
│   ├── cache/                    # 嵌入缓存
│   └── chroma/                   # 向量数据库
├── docs/plans/                   # 设计文档
└── requirements.txt              # Python 依赖
```

---

## 六、自动记录触发器

### 6.1 触发条件

**当 AI 完成一个"有价值的动作"时，自动生成记录：**

- 修复了 bug
- 做了技术选择/决策
- 发现了性能问题/陷阱
- 理解了复杂逻辑
- 总结了通用经验

### 6.2 记录流程

```
┌─────────────────────────────────────────────────────────────┐
│  任务完成                                                    │
│  │                                                           │
│  ▼                                                           │
│  AI 生成 1-3 条简洁总结                                      │
│  │                                                           │
│  ▼                                                           │
│  显示预览，询问："保存这些记录？"                            │
│  │                                                           │
│  ├─ 是 → 写入 insight 文件 + 更新索引                        │
│  └─ 否 → 放弃                                               │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 记录模板

```markdown
---
title: {简短标题}
type: lesson|failure|decision
tags: {自动提取或空}
created: {自动时间}
---

## 结论
{一句话}

## 背景
{为什么}

## 关键点
1. ...
2. ...
```

### 6.4 AI 调用流程

```
┌─────────────────────────────────────────────────────────────┐
│  AI 会话开始                                                 │
│  │                                                           │
│  1. 调用 GET /status 检查索引是否需要更新                   │
│  2. 如需要，调用 POST /index                                 │
│  3. 根据当前任务调用 GET /search?q={当前任务}               │
│  4. 读取返回的文件内容 (Read 工具)                          │
│  5. 开始工作                                                 │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  任务中                                            │   │
│  │  - 遇到问题 → 重复步骤 3-4 检索相关上下文            │   │
│  │  - 完成有价值的工作 → 生成总结 → 询问是否保存        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 七、迁移与部署

### 7.1 一键打包

```bash
# 打包
tar czf yc-cli-rag-backup.tar.gz .rag/ ai-docs/ rag/

# 恢复
tar xzf yc-cli-rag-backup.tar.gz
```

### 7.2 跨平台迁移

| 包含内容 | 迁移方式 | 说明 |
|---------|---------|------|
| .rag/chroma/ | 复制 | 向量数据库 |
| .rag/cache/ | 可选 | 嵌入缓存，可重建 |
| ai-docs/ | git 或复制 | 文档源文件 |
| rag/ | 复制 | 服务代码 |

### 7.3 新环境部署

```bash
# 1. 复制文件
cp -r yc-cli/ /new/location/

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动服务
./run_server.sh
```

---

## 八、关键原则

1. **YAGNI** - 先实现核心功能，不添加过多特性
2. **文件优先** - md 文件是权威源，DB 可随时重建
3. **自动记录** - AI 主动生成，你确认后保存
4. **简单可读** - 代码保持简洁，便于维护
