# CAF‑niche 分析任务（规格化/可验收）

本文件定义两个阶段的实现规格：

- **Stage 1**：在 `script/caf_niche_batch.R` 的基础上新建脚本，实现 **section normalization**（按整张切片组成归一化）并输出 raw/corrected 两套结果与 PDF 图。
- **Stage 2**：新增全局对齐脚本，基于 **Pearson 相关**对不同样本的 CAF 亚群进行相似度聚类，实现跨样本“同名化”（类似文献 FigA 的相关性热图 + dendrogram）。

关键约束（全程必须满足）：

- 不修改 `utils/R/niche.R`。
- 颜色 **不要手动固定**（不要写死 hex），只允许用 `ggsci::scale_*_d3("category20")`；但必须通过 **统一 factor levels** + `limits`/`breaks`/`drop=FALSE` 固定映射顺序。
- coarse 只用 `annotation_coarse`；fine 可保留但默认不跑。
- 所有图输出为 **矢量 PDF**（建议 `cairo_pdf`）。

---

## Stage 1：Section normalization 的 CAF‑niche batch 脚本

### 1) 交付物
- 新建：`script/caf_niche_batch_sectionnorm.R`
  - 从 `script/caf_niche_batch.R` 复制后改造（不要改原文件）。

### 2) 统一 coarse level（必须）
对每个样本读入 Seurat 后，强制将 `annotation_coarse` 的 levels 统一为：

`B_cell, CAF, Endothelial, Myeloid, Stromal_other, T_cell, Tumor`

实现规则：

1. `x <- as.character(seu@meta.data[[anno_coarse]])`
2. 若 `x` 中存在不在上述 7 类里的值：默认 `stop()` 并打印未知值列表与 sample_id。
3. `seu@meta.data[[anno_coarse]] <- factor(x, levels = CANONICAL_LEVELS)`

说明：只固定 **level 顺序**，不固定颜色；颜色交给 ggsci 的 category20，但必须通过 `limits/breaks/drop=FALSE` 让映射在跨样本时稳定。

### 3) 坐标与物理尺度（必须）
仍按既定规则把 spatial 坐标转为 μm：

```r
coords <- Embeddings(seu, reduction = "spatial")
coords <- coords * 50
seu[["spatial"]]@cell.embeddings <- coords
```

绘图使用 `Center_X/Center_Y` 时同样乘 0.5。

### 4) 邻域定义与半径 r（必须）
- 每个 CAF 为中心，邻域为半径 `r = 80 μm` 的圆。
- 仍保留 r scan 能力，但默认使用 `--r_fixed 80`（即默认不扫描）。
- 需要输出 `r_choice.tsv`；如扫描则额外输出 `r_scan.tsv`、`r_scan.pdf`。
- 日志需打印：该 r 下 CAF 的 median neighbor count（用于检查是否接近文献的 “~100 neighbors/CAF”）。

### 5) 邻域组成矩阵（raw）
使用 `CalNichMatrix()`（来自 `utils/R/niche.R`）计算 CAF 邻域 cell type composition：

- `niche_count`：CAF×celltype（counts）
- `niche_raw`：CAF×celltype（fraction；每行和≈1）

列必须补齐并按 canonical 7 列排序（缺失列补 0）：

`B_cell, CAF, Endothelial, Myeloid, Stromal_other, T_cell, Tumor`

按样本输出（至少）：

- `niche_celltype_fraction.tsv`（CAF×7；raw fraction）
- 可选但推荐：`niche_celltype_count.tsv`

### 6) 整张切片组成（section_prop）
对全体细胞按 `annotation_coarse`（canonical levels）统计比例，得到：

- `section_prop`：长度=7 的向量（按 canonical 顺序）
- 输出：`section_celltype_fraction.tsv`（两列：`cell_type`, `fraction`，按 canonical 顺序写出）

### 7) Section normalization（核心）
对每个 CAF 的邻域组成向量按列除以切片整体比例：

`corrected = niche_raw / section_prop`

规则：

- `section_prop == 0`：该列先置 `NA` 再做除法
- 最终 `corrected` 中的 `NA/Inf/-Inf` 必须全部置为 `0`
- **不要**再把 corrected 行归一化为和=1（保留 enrichment/depletion 幅度）

输出（按样本）：

- `niche_celltype_corrected.tsv`（CAF×7）

### 8) NMF + Leiden（主流程不变，输入替换为 corrected）
- 默认 `--k_list "5,6"`（可改参数覆盖）。
- NMF 输入矩阵：
  - 若 `--use_section_normalization true`：使用 corrected
  - 若 false：使用 raw fraction（兼容旧行为）
- Leiden 聚类仍在 NMF 的 cell-by-factor matrix（W）上进行。

#### CAF 子群数量上限（不超过 5）
需要提供机制确保 CAF 亚群数 ≤ 5（默认）：

- 参数：
  - `--cluster_resolution 0.1`
  - `--max_caf_clusters 5`
  - `--cluster_resolution_step 0.02`
  - `--min_cluster_resolution 0.02`
- 逻辑：若 cluster 数 > max，则 resolution 按 step 递减，直到满足或到 min；每次调整要在 log 中打印。

### 9) 输出文件（每样本每 k）
除 Stage 1 的 raw/corrected/section 输出外，每个 k 需要输出：

- `nmf_H_k{k}.tsv`
- `caf_clusters_k{k}.tsv`（`cell_id`, `caf_cluster`）
- `caf_cluster_summary_k{k}.tsv`

并生成 cluster 平均 profile（raw 与 corrected 都要）：

- `niche_average_raw_k{k}.tsv`（cluster×7）
- `niche_average_corrected_k{k}.tsv`（cluster×7）

### 10) 可视化（raw vs corrected 都要；PDF）
每个样本每个 k 至少输出 4 张 PDF：

- `niche_bar_raw_k{k}.pdf`
- `niche_heatmap_raw_k{k}.pdf`
- `niche_bar_corrected_k{k}.pdf`
- `niche_heatmap_corrected_k{k}.pdf`

色板与顺序要求（必须）：

- 堆叠柱图：
  - `ggsci::scale_fill_d3("category20", limits=CANONICAL_LEVELS, breaks=CANONICAL_LEVELS, drop=FALSE)`
- 空间图：
  - `ggsci::scale_color_d3("category20", limits=CANONICAL_LEVELS, breaks=CANONICAL_LEVELS, drop=FALSE)`

目的：即使某个 niche 中没有 B_cell，也必须在 legend 里显示 B_cell 且有颜色。

### 11) Spatial niche PDF（每 CAF cluster）
每个样本每个 k 的每个 CAF cluster 输出一个 PDF（两 panel 或两页）：

1. 全切片灰底 + 该 cluster 的 CAF anchors（红色）
2. 全切片灰底 + niche cells（按 `annotation_coarse` 上色；使用 canonical levels + d3 色板）

文件名建议：`caf_niche_spatial_k{k}_{cluster_id}.pdf`

### 12) plot_only 模式（必须兼容）
参数：`--plot_only true/false`（默认 false）

- plot_only=true 时：
  - 不做 r scan、不做 CalNichMatrix、不做 NMF/Leiden
  - 只读取已有的 tsv 并重画 PDF
  - spatial 图允许进行一次轻量 `dbscan::frNN` 邻域计算（用于从 CAF cluster 推导 niche cells）
- 缺文件时必须 `warning()` 并跳过对应图，不得整体崩溃：
  - 缺 raw 平均矩阵 → 跳过 raw 图
  - 缺 corrected 平均矩阵 → 跳过 corrected 图
  - 缺 `caf_clusters_k{k}.tsv` → 跳过该 k 的 spatial 图

### 13) Stage 1 验收（必须可执行）
运行：

```bash
Rscript script/caf_niche_batch_sectionnorm.R --samples 20P --input data --output data/caf_niche_sectionnorm
```

验收点：

- `data/caf_niche_sectionnorm/20P/` 下存在 Stage 1 规定的 tsv 与 pdf
- `niche_celltype_fraction.tsv` 每行 sum≈1
- `section_celltype_fraction.tsv` sum≈1
- `niche_celltype_corrected.tsv` 无 NA/Inf
- 每个 k 的 CAF cluster 数 ≤ 5（除非到 min_resolution 仍超；此时必须 warning）

---

## Stage 2：跨样本 CAF 亚群全局对齐（Pearson 相似度 + 层次聚类）

### 1) 目标
解决“每个样本内 CAF-1/CAF-2… 编号不同但实际相同”的问题。

做法：把每个样本的 CAF local cluster 用其 **邻域组成 profile** 表示（推荐 corrected 的 cluster 平均），计算 cluster‑by‑cluster 的 Pearson 相关矩阵，层次聚类得到 dendrogram，并 cutree 得到全局 subtype（类似文献 FigA）。

### 2) 交付物
- 新建：`script/caf_niche_global_alignment.R`
  - 只依赖 Stage 1 输出，不改 `utils/R/niche.R`。

### 3) 输入依赖（来自 Stage 1 输出）
对每个样本至少需要：

- `caf_cluster_summary_k{k}.tsv`
- `caf_clusters_k{k}.tsv`（可选：用于写回 per-cell 全局命名）
- `niche_average_raw_k{k}.tsv` / `niche_average_corrected_k{k}.tsv`

### 4) CLI 参数（必须 + 默认）
- `--input_root`（默认：`data/caf_niche_sectionnorm`）
- `--output_root`（默认：`data/caf_niche_sectionnorm/_global`）
- `--samples`（默认空）
- `--k_local`（默认：`5`）
- `--profile`（默认：`corrected`；可选 raw）
- `--corr_method`（默认：`pearson`；可选 spearman）
- `--transform`（默认：`log2p`；可选 none/log1p）
- `--eps`（默认：`1e-6`）
- `--hclust_method`（默认：`average`）
- `--k_global`（默认：`auto`；或整数）
- `--k_global_min`（默认：`2`），`--k_global_max`（默认：`8`）
- `--min_cluster_cells`（默认：`200`）：小于阈值的 local cluster 不参与全局聚类（但要在 mapping 里记录）
- `--sample_meta`（默认空；可选 TSV，含 `sample_id`，可含 `cancer_type`,`platform` 用于热图注释条）
- `--write_renamed_clusters`（默认：`true`）：是否写 `caf_clusters_k{k}_global.tsv`（不覆盖原文件）

### 5) 全局 profile 构建（必须）
对所有样本的所有 local cluster 读取 `niche_average_{profile}_k{k_local}.tsv`：

- 行名：`{sample_id}::{local_cluster}`（例如 `19L::CAF-3`）
- 列：canonical 7 类（缺列补 0，多余列报错）
- 形成矩阵 `M`（row=cluster，col=7 celltypes）

可选变换：

- `log2p`：`M <- log2(M + eps)`
- `log1p`：`M <- log1p(M)`（或 `log1p(M/eps)`，需在 help 中明确）
- `none`：不变

### 6) 相似度矩阵与层次聚类（必须）
- `C <- cor(t(M), method=corr_method, use="pairwise.complete.obs")`
- 距离：`D <- as.dist(1 - C)`（必要时 clamp）
- `hc <- hclust(D, method=hclust_method)`

### 7) 全局 subtype 数量选择（auto 必须支持）
若 `--k_global` 为整数：直接 cutree。

若 `auto`：对 `K in [k_global_min, k_global_max]`：

- `labels_K <- cutree(hc, k=K)`
- `within(K)`：同簇 pair 的相关系数中位数
- `between(K)`：不同簇 pair 的相关系数中位数
- `score(K) = within(K) - between(K)`

取 score 最大的 K（并列取更小 K）。

输出：

- `global_k_scan.tsv`
- `global_k_scan.pdf`

### 8) 全局 subtype 命名（必须稳定）
- 生成 `s1-CAFs, s2-CAFs, ... sK-CAFs`
- 编号顺序：按 `hc` 的叶子顺序从左到右稳定编号（不可依赖因子排序随机性）

### 9) 输出文件（必须）
输出到：`{output_root}/k{k_local}/{profile}/`

- `profiles.tsv`
- `correlation.tsv`
- `hclust_order.tsv`
- `global_subtype_mapping.tsv`
  - `cluster_id`（sample::local_cluster）
  - `sample_id`
  - `local_cluster`
  - `n_cells`
  - `excluded_from_global`（n_cells < min_cluster_cells）
  - `global_subtype`（1..K 或 NA）
  - `global_label`（sX-CAFs 或 NA）
- `global_subtype_centroids.tsv`（每个 sX-CAFs 的平均 profile）
- `global_similarity_heatmap.pdf`（矢量）
  - 相关性热图 + dendrogram
  - 顶部/侧边标注 global subtype；若有 sample_meta，则加 cancer_type/platform 注释条

若 `write_renamed_clusters=true`：

- 对每个样本写 `caf_clusters_k{k_local}_global.tsv`（新增列 `caf_cluster_global`），不覆盖原始文件。

### 10) Stage 2 验收（必须可执行）
示例运行：

```bash
Rscript script/caf_niche_global_alignment.R \
  --input_root data/caf_niche_sectionnorm \
  --output_root data/caf_niche_sectionnorm/_global \
  --samples 19L,20P,13P \
  --k_local 5 \
  --profile corrected \
  --k_global auto
```

验收点：

- 输出目录存在 `global_similarity_heatmap.pdf` 与 `global_subtype_mapping.tsv`
- mapping 中至少有部分 global subtype 同时包含多个样本的 local cluster（实现“同名化”）
- 若启用写回：各样本目录新增 `caf_clusters_k5_global.tsv`，且原 `caf_clusters_k5.tsv` 未被覆盖
