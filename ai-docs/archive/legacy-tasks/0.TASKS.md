# PCF CAF/TLS 探索任务清单

## 0. 已确认的前提
- [x] 样本命名解析：以 `cleandata/<sample_id>` 为准（例如 `20P`），文件名 `patientsite_xxx_objects.tsv` 中 `xxx` 可有可无。
- [x] 注释策略：
  - Tumor：按 `CLDN18.2` + `P5CS` 分层（不再用 PYCR1）。
  - CAF：保留 `PYCR1+/-` 细分，仅用于后续解释。
  - Immune：使用 `T / B / Myeloid` 粗分；`annotation_coarse` 用于 CAF‑niche；`annotation_fine` 用于细节。
- [x] TLS-like 判定阈值：B cluster >= 30；T cell（局部）>= 20；GC-like：Ki67+ B 比例 >= 5% 且数量 >= 5。
- [x] 新脚本：`PCF/build_spatialdata_batch_h5ad_only.py`（仅输出 h5ad）。

## 1. 数据生成与转换
- [ ] 批量生成 h5ad：`python PCF/build_spatialdata_batch_h5ad_only.py`
- [ ] 批量转换 Seurat：`Rscript convert_h5ad_to_seurat.R`
- [ ] 抽样检查 `annotation_coarse` / `annotation_fine` 是否完整且合理。

## 2. QC 与预处理
- [ ] 过滤 `Negative_or_Artifact` 与 `Unknown`。
- [ ] 坐标完整性检查（缺失/异常范围样本标记为不可做空间分析）。
- [ ] 关键 positivity 缺失标记（特别是 P5CS、Vimentin、CD20、CD3e）。
- [ ] 样本组成异常预警（如 B 细胞过少 → TLS 不可评估）。
- [ ] 生成 QC 表（样本级/部位级）。

## 3. CAF‑niche 分析（密度自适应 r）
- [ ] 对每个样本扫描 r（CAF 邻居数曲线），选取稳定区间的 r。
- [ ] 以 CAF 为中心计算邻域组成（`annotation_coarse`）。
- [ ] 邻域内归一化 + 全切片 composition 修正（niche.mat.correct）。
- [ ] NMF（k=4/5）→ 在 NMF 空间聚类 CAF，控制 4–5 类 niche。
- [ ] 空间可视化 + 组成热图 + 堆叠条形图。
- [ ] 以 `annotation_fine` 解释 niche 内细节（CAF_PYCR1+/−、Tumor_P5CS+/− 等）。

## 4. TLS‑like 分析（密度自适应 r）
- [ ] 对 B 细胞计算 r_B（邻居数曲线），设 r_T = r_B（或 1.5× 作为敏感性分析）。
- [ ] B cluster 识别（DBSCAN）；B cluster >= 30 进入判定。
- [ ] 局部 T cell >= 20 → TLS‑like presence。
- [ ] Ki67+ B 比例 >= 5% 且数量 >= 5 → GC‑like。
- [ ] 输出 TLS‑like 数量/密度/成熟度，并做 P/L/R/QT 比较（患者内优先）。

## 5. 结果输出与解读
- [ ] CAF‑niche：空间图、组成热图、niche 比例表。
- [ ] TLS‑like：空间分布、数量/密度/成熟度统计表。
- [ ] 部位差异汇总（P/L/R/QT）。
- [ ] 明确“TLS‑like 操作性定义”的不确定性说明。
