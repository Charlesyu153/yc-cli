# AI Agents 使用示例

本文档提供 PCF 项目中三个 AI agents 的详细使用示例。

## 目录

1. [基本使用方法](#基本使用方法)
2. [code-architect 使用示例](#code-architect-使用示例)
3. [code-explorer 使用示例](#code-explorer-使用示例)
4. [code-reviewer 使用示例](#code-reviewer-使用示例)
5. [Feature-Dev 完整工作流](#feature-dev-完整工作流)
6. [常见场景示例](#常见场景示例)

---

## 基本使用方法

### 调用 Agent 的方式

在与 Claude Code 对话时，使用以下格式调用特定 agent：

```
请以 [agent-name] 的角色，[具体任务描述]
```

例如：
```
请以 code-explorer 的角色，帮我查找所有处理 SpatialData 的函数
```

### Agent 配置文件

所有 agent 的配置都存储在 `.claude/agents/` 目录下：
- `agents.json` - 主配置文件
- `code-architect.json` - 架构师配置
- `code-explorer.json` - 探索者配置
- `code-reviewer.json` - 审查者配置

---

## code-architect 使用示例

### 示例 1: 设计新功能架构

**场景**: 需要添加一个新的质控统计功能

**提示语**:
```
请以 code-architect 的角色，帮我设计一个新的质控统计功能。

需求：
1. 统计每个样本的细胞数量、标记表达情况
2. 生成质控报告（CSV 和可视化图表）
3. 支持批量处理 18 个样本

请提供：
1. 架构设计方案
2. 模块划分建议
3. 详细的实施步骤
4. 需要创建的文件列表
```

**预期输出**:
- 架构设计方案（模块划分、数据流）
- 实施步骤清单
- 文件组织建议
- 技术选型说明

### 示例 2: 重构超过 500 行的脚本

**场景**: 某个 Python 脚本超过 500 行，需要模块化

**提示语**:
```
请以 code-architect 的角色，帮我重构 PCF/build_spatialdata_batch.py

要求：
1. 检查当前文件行数
2. 分析功能模块
3. 设计模块化方案（拆分成多个文件）
4. 确保向后兼容性
5. 提供详细的重构步骤
```

**预期输出**:
- 当前代码分析
- 模块划分方案
- 文件结构设计
- 重构步骤清单
- 风险评估

### 示例 3: 评估技术方案

**场景**: 需要选择合适的数据存储格式

**提示语**:
```
请以 code-architect 的角色，帮我评估以下数据存储方案：

背景：需要存储 18 个样本的空间转录组数据
选项：
1. h5ad 格式（AnnData）
2. zarr 格式（SpatialData）
3. qs 格式（Seurat）

请分析：
1. 各方案的优缺点
2. 性能对比（读写速度、存储空间）
3. 与现有工具链的兼容性
4. 推荐方案及理由
```

---

## code-explorer 使用示例

### 示例 1: 查找特定功能实现

**场景**: 需要找到所有处理 CAF 细胞类型的代码

**提示语**:
```
请以 code-explorer 的角色，帮我查找所有处理 CAF 细胞类型的代码。

需要：
1. 查找包含 "CAF" 关键字的所有文件
2. 定位关键函数的位置（文件:行号）
3. 分析这些代码的功能
4. 总结 CAF 相关的处理流程
```

**预期输出**:
- 相关文件列表（带路径和行号）
- 关键函数说明
- 代码功能总结
- 处理流程图

### 示例 2: 理解复杂分析流程

**场景**: 需要理解 CAF Niche v2 的完整分析流程

**提示语**:
```
请以 code-explorer 的角色，帮我理解 CAF Niche v2 的完整分析流程。

请分析：
1. script/caf_niche_v2/ 目录下的所有脚本
2. 脚本的执行顺序和依赖关系
3. 每个脚本的主要功能
4. 输入输出数据
5. 关键函数和参数

最后生成一份流程文档。
```

### 示例 3: 追踪函数调用链

**场景**: 需要了解某个函数被哪些地方调用

**提示语**:
```
请以 code-explorer 的角色，追踪 build_spatialdata() 函数的调用链。

需要：
1. 找到函数定义位置
2. 查找所有调用该函数的地方
3. 分析调用上下文
4. 绘制调用关系图
```

---

## code-reviewer 使用示例

### 示例 1: 审查单个文件

**场景**: 审查新编写的 Python 脚本

**提示语**:
```
请以 code-reviewer 的角色，审查 PCF/qc_summary.py

检查项：
1. 文件行数是否超过 500 行
2. 是否符合 PEP 8 规范
3. 代码质量和可维护性
4. 潜在的 bug 和性能问题
5. 提供具体的改进建议
```

**预期输出**:
- 审查总结（文件信息、整体评分）
- 发现的问题（严重/改进/风格）
- 优点总结
- 改进代码示例

### 示例 2: 批量审查目录

**场景**: 审查整个分析脚本目录

**提示语**:
```
请以 code-reviewer 的角色，审查 script/caf_niche_v2/ 目录下的所有 R 脚本。

重点检查：
1. 哪些文件超过 500 行（需要重构）
2. 代码规范符合性（2-space 缩进、snake_case）
3. 共性问题和改进建议
4. 优先级排序（哪些问题最需要修复）
```

### 示例 3: 规范符合性检查

**场景**: 检查代码是否符合项目规范

**提示语**:
```
请以 code-reviewer 的角色，检查以下代码是否符合项目规范：

文件：script/convert_h5ad_to_seurat.R

项目规范（参考 docs/AGENTS.md）：
- R: 2-space 缩进
- 函数名使用 snake_case
- 使用 file.path() 处理路径
- 单文件不超过 500 行
- 适当的错误处理和日志输出

请提供详细的符合性报告。
```

---

## Feature-Dev 完整工作流

### 场景: 开发新的数据导出功能

完整的功能开发流程，展示如何协调使用三个 agents。

#### 阶段 1: 探索现有代码 (code-explorer)

**提示语**:
```
请以 code-explorer 的角色，帮我了解现有的数据导出功能。

需求：我想添加一个新功能，将 SpatialData 导出为 CSV 格式

请帮我：
1. 查找现有的数据导出相关代码
2. 了解当前支持的导出格式
3. 分析现有导出函数的实现模式
4. 总结可以复用的代码
```

#### 阶段 2: 设计实现方案 (code-architect)

**提示语**:
```
请以 code-architect 的角色，基于刚才的探索结果，设计 CSV 导出功能。

需求：
- 支持导出细胞元数据
- 支持导出标记表达矩阵
- 支持批量导出 18 个样本
- 提供进度显示

请提供：
1. 架构设计（模块划分）
2. 函数接口设计
3. 详细实施步骤
4. 需要创建/修改的文件
```

#### 阶段 3: 实现代码

根据设计方案实现代码（此阶段不需要特定 agent）

#### 阶段 4: 代码审查 (code-reviewer)

**提示语**:
```
请以 code-reviewer 的角色，审查刚才实现的 CSV 导出功能。

文件：PCF/export_to_csv.py

检查：
1. 代码质量和规范符合性
2. 错误处理是否完善
3. 性能是否合理（大数据集处理）
4. 是否有潜在问题
5. 提供改进建议
```

#### 阶段 5: 修改和提交

根据审查意见修改代码，更新文档，提交到 git。

---

## 常见场景示例

### 场景 1: 快速定位 Bug

**问题**: 某个样本处理失败，需要快速定位问题

**步骤**:
```
1. 使用 code-explorer 查找相关的处理代码
   提示语：请以 code-explorer 的角色，查找处理样本 [样本名] 的所有相关代码

2. 使用 code-reviewer 审查可能有问题的代码
   提示语：请以 code-reviewer 的角色，审查 [文件路径]，重点检查错误处理和边界情况
```

### 场景 2: 添加新的分析步骤

**需求**: 在 CAF Niche 分析流程中添加新的统计分析

**步骤**:
```
1. code-explorer: 理解现有的分析流程
2. code-architect: 设计新分析步骤的集成方案
3. 实现代码
4. code-reviewer: 审查新代码
5. 提交并更新文档
```

### 场景 3: 优化性能

**问题**: 某个脚本运行太慢，需要优化

**步骤**:
```
1. code-reviewer: 审查代码，识别性能瓶颈
   提示语：请以 code-reviewer 的角色，审查 [文件]，重点分析性能问题

2. code-architect: 设计优化方案
   提示语：请以 code-architect 的角色，基于审查结果，设计性能优化方案

3. 实现优化
4. code-reviewer: 验证优化效果
```

### 场景 4: 代码重构

**问题**: 发现某个文件超过 500 行，需要重构

**步骤**:
```
1. code-reviewer: 检查文件行数并分析代码结构
   提示语：请以 code-reviewer 的角色，检查 [文件] 的行数，并分析可以模块化的部分

2. code-architect: 设计重构方案
   提示语：请以 code-architect 的角色，设计模块化重构方案，确保不破坏现有功能

3. 执行重构
4. code-reviewer: 验证重构结果
```

---

## 最佳实践

### 1. Agent 协作原则

- **探索优先**: 在设计之前，先用 code-explorer 充分了解现有代码
- **设计先行**: 在实现之前，用 code-architect 设计好方案
- **审查保障**: 在提交之前，用 code-reviewer 确保质量

### 2. 提示语编写技巧

- **明确角色**: 始终以 "请以 [agent-name] 的角色" 开头
- **具体需求**: 清晰描述要做什么，期望得到什么
- **提供上下文**: 说明背景信息和约束条件
- **分步骤**: 将复杂任务分解为具体步骤

### 3. 遵循项目规范

所有 agents 都会遵循项目规范：
- 禁止使用表情符号
- 代码文件不超过 500 行
- 遵循 Python (PEP 8) 和 R 编码规范
- 每完成一步就 commit
- 任务完成后归档文档

---

## 快速参考

### Agent 选择指南

| 需求 | 使用 Agent |
|------|-----------|
| 查找代码位置 | code-explorer |
| 理解代码结构 | code-explorer |
| 设计新功能 | code-architect |
| 评估技术方案 | code-architect |
| 重构代码 | code-architect |
| 审查代码质量 | code-reviewer |
| 检查规范符合性 | code-reviewer |
| 发现潜在问题 | code-reviewer |

### 配置文件位置

- 主配置: `.claude/agents/agents.json`
- 使用文档: `.claude/agents/USAGE_EXAMPLES.md` (本文档)
- 项目规范: `docs/AGENTS.md`
- AI 协作规范: `ai-docs/templates/ai-guidelines.md`

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-12
